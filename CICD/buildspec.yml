version: 0.2
phases:
 install:
   commands:
     - echo "Install backend"
     - cd backend
     - npm install -g serverless
     - wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/5.2.4/flyway-commandline-5.2.4-linux-x64.tar.gz | tar xvz
     - ln -sf '../libjsig.so' flyway-5.2.4/jre/lib/amd64/server/libjsig.so # Workaround for https://github.com/flyway/flyway/issues/2312
     - echo "Install frontend"
     - cd ../frontend/turo-app
     - npm install
 pre_build:
   commands:
     - echo "pre_build step"
 build:
   commands:
     - echo "Deploy backend"
     - cd ../../backend
     - serverless deploy -v
     - echo "Migrate database"
     - flyway-5.2.4/flyway migrate --url="terraform-20190324164159438000000001.ccahsd6rorzm.eu-west-1.rds.amazonaws.com" --user="db_admin" password="$(aws ssm get-parameter --name turo_db_admin_password --with-decryption --output text --query Parameter.Value)"
     - echo "Build React app"
     - cd ../frontend/turo-app
     - npm run build
     - aws s3 sync build s3://turo-app
 post_build:
   commands:
     - echo "post_build step"
